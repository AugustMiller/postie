{% extends 'postie/_layouts/layout' %}

{% set crumbs = [
    { label: "Postie Settings"|t, url: url('postie/settings') },
    { label: "Provider {provider}"|t({ provider: provider.getName() }), url: url('postie/settings/' ~ provider.getHandle()) },
] %}

{% set providersConf = craft.config.get('providers', 'postie') %}
{% if providersConf and providersConf[provider.getHandle()] is defined %}
    {% set providerConfig = providersConf[provider.getHandle()] is defined ? providersConf[provider.getHandle()] : [] %}
    {% set providerSettings = providersConf[provider.getHandle()].settings is defined ? providersConf[provider.getHandle()].settings : [] %}
    {% set shippingMethodSettings = providersConf[provider.getHandle()].services is defined ? providersConf[provider.getHandle()].services : [] %}
{% else %}
    {% set providerSettings = [] %}
    {% set shippingMethodSettings = [] %}
{% endif %}

{% if craft.postie.isLicensed %}
    {% set fullPageForm = true %}
{% endif %}

{% block blockContent %}

    {% set placeholder = (shippingMethodSettings[shippingMethod.handle] is defined) ? shippingMethodSettings[shippingMethod.handle] : false %}
    {% set warning = placeholder ? "This is being overridden in {file}." | t({file: 'craft/config/postie.php'}) %}
    {% set value = placeholder ? placeholder : shippingMethod.name %}

    <div id="shipping-method-tab">
        <input type="hidden" name="action" value="postie/shippingMethods/save">
        <input type="hidden" name="redirect" value="postie/settings/{{ provider.getHandle() }}/shippingmethods/{{ shippingMethod.handle }}">
        <input type="hidden" name="provider" value="{{ provider.getHandle() }}">
        <input type="hidden" name="handle" value="{{ shippingMethod.handle }}">

        {{ forms.textField({
            first: true,
            label: "Name"|t,
            instructions: "What this shipping method will be called in the CP."|t,
            id: 'name',
            name: 'name',
            value: shippingMethod.getName(),
            errors: shippingMethod.getErrors('name'),
            autofocus: true,
            required: true,
            disabled: placeholder,
            placeholder: placeholder,
            warning: warning
        }) }}

        <code>{{ shippingMethod.handle }}</code>

        {{ forms.checkboxField({
            label: "Enable this shipping method on the front end"|t,
            id: 'enabled',
            name: 'enabled',
            value: 1,
            checked: shippingMethod.enabled,
            errors: shippingMethod.getErrors('enabled'),
            disabled: placeholder,
            placeholder: placeholder,
            warning: warning
        }) }}

        {% if placeholder %}
            <input type="hidden" name="name" value="{{ placeholder }}">
            <input type="hidden" name="enabled" value="1">
        {% endif %}

        <br>

        <h3>{{ "Shipping Category Conditions"|t }}</h3>
        {% set shippingCategories = craft.commerce.shippingCategories%}
        {% if shippingCategories %}
            <table id="shipping-categories-conditions" class="data fullwidth collapsible">
                <thead>
                <tr>
                    <th scope="col">{{ 'Name'|t }}</th>
                    <th scope="col">{{ 'Condition'|t }}</th>
                </tr>
                </thead>
                <tbody>
                {% for shippingCategory in shippingCategories %}
                    {% set id = shippingCategory.id %}
                    <tr{% if id %} data-id="{{ id }}" data-name="{{ shippingCategory.name }}"{% endif %}>
                        <th scope="row" data-title="{{ 'Name'|t }}">
                            {{ shippingCategory.name }}
                        </th>
                        <td data-title="{{ 'Condition'|t }}">
                            {{ forms.selectField({
                                name: 'ruleCategories['~shippingCategory.id~'][condition]',
                                value: shippingRule.getShippingRuleCategories[shippingCategory.id].condition ?? 'allow',
                                options: categoryShippingOptions
                            }) }}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        {% endif %}
    </div>

{% endblock %}